---
- name: "set centos {{ release.version + ' ' + release.arch + ' ' + release.build }} url"
  set_fact:
    centos_url: >-
      https://cloud.centos.org/centos/{{ release.version[0] }}/{{
      (release.version[0] == '8') | ternary(release.arch + '/images', 'images') }}/CentOS-{{
      release.version[0] }}{{ (release.version[0] == '8') | ternary('', '-' + release.arch) }}-GenericCloud-{{
      (release.version[0] == '8') | ternary(
        release.version + '.' + release.build + '-' + release.date + '.' + release.arch,
        release.build
      ) }}.qcow2

- name: "download centos {{ release.version + ' ' + release.arch + ' ' + release.build }} image"
  get_url:
    url: "{{ centos_url }}"
    checksum: "{{ (release.version[0] == '8') | ternary(omit, 'sha256:https://cloud.centos.org/centos/7/images/sha256sum.txt') }}"
    dest: "{{ os_image_dir }}/centos-{{ release.version }}-{{ release.arch }}-genericcloud-{{ release.build }}.qcow2"

- name: "convert centos {{ release.version + ' ' + release.arch + ' ' + release.build }} qcow2 => raw"
  command: >-
    qemu-img convert -f qcow2 -O raw
    {{ os_image_dir }}/centos-{{ release.version }}-{{ release.arch }}-genericcloud-{{ release.build }}.qcow2
    {{ os_image_dir }}/centos-{{ release.version }}-{{ release.arch }}-genericcloud-{{ release.build }}.raw
  args:
    creates: "{{ os_image_dir }}/centos-{{ release.version }}-{{ release.arch }}-genericcloud-{{ release.build }}.raw"

- name: "upload centos {{ release.version + ' ' + release.arch + ' ' + release.build }} to openstack"
  os_image:
    cloud: "{{ os_cloud }}"
    validate_certs: false
    #<<: *os_cloud_auth
    filename: "{{ os_image_dir }}/centos-{{ release.version }}-{{ release.arch }}-genericcloud-{{ release.build }}.raw"
    name: "centos-{{ release.version }}-{{ release.arch }}-genericcloud-{{ release.build }}"
    disk_format: raw
    is_public: true
